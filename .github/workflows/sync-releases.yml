name: Sync RevokeMsgPatcher Releases & Assets
on:
  workflow_dispatch:  # 手动触发同步
  schedule:
    - cron: '0 0 * * *'  # 每天自动同步一次
  watch:
    types: [started]    # 当你star原仓库时触发同步

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.repository }}

      - name: Mirror Git Tags
        run: |
          git remote add upstream https://github.com/huiyadanli/RevokeMsgPatcher.git 
          git fetch upstream --tags
          git push origin --tags --force

      - name: Sync Releases with Assets
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { promisify } = require('util');
            const download = promisify(require('download'));

            // 获取原仓库所有Releases
            const { data: sourceReleases } = await github.rest.repos.listReleases({
              owner: 'huiyadanli',
              repo: 'RevokeMsgPatcher',
              per_page: 100
            });

            // 获取目标仓库已有的Releases
            const { data: targetReleases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // 过滤需要同步的Releases
            const existingTags = targetReleases.map(r => r.tag_name);
            const releasesToSync = sourceReleases.filter(r => !existingTags.includes(r.tag_name));

            // 批量同步Releases和Assets
            for (const release of releasesToSync) {
              console.log(`同步版本: ${release.tag_name}`);
              
              // 创建Release
              const { data: targetRelease } = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: release.tag_name,
                name: release.name,
                body: release.body,
                draft: release.draft,
                prerelease: release.prerelease
              });

              // 下载并上传Assets
              for (const asset of release.assets) {
                console.log(`同步Asset: ${asset.name}`);
                try {
                  // 下载Asset到临时目录
                  const downloadPath = await download(asset.browser_download_url, 'tmp');
                  
                  // 上传Asset到目标Release
                  await github.rest.repos.uploadReleaseAsset({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: targetRelease.id,
                    name: asset.name,
                    data: fs.readFileSync(path.join('tmp', asset.name))
                  });
                  
                  // 清理临时文件
                  fs.unlinkSync(path.join('tmp', asset.name));
                } catch (error) {
                  console.error(`同步Asset失败: ${asset.name}`, error);
                }
              }
            }
