name: Sync RevokeMsgPatcher Releases & Assets
on:
  workflow_dispatch:  # 手动触发同步
  schedule:
    - cron: '0 0 * * *'  # 每天自动同步一次
  watch:
    types: [started]    # 当你star原仓库时触发同步

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.repository }}

      - name: Mirror Git Tags
        run: |
          git remote add upstream https://github.com/huiyadanli/RevokeMsgPatcher.git 
          git fetch upstream --tags
          git push origin --tags --force

      - name: Sync Releases with Assets
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const http = require('http');
            const https = require('https');
            const { URL } = require('url');

            // 下载文件的辅助函数，手动处理重定向
            async function downloadFile(url, filePath) {
              return new Promise((resolve, reject) => {
                const download = (currentUrl) => {
                  const parsedUrl = new URL(currentUrl);
                  const client = parsedUrl.protocol === 'https:' ? https : http;
                  
                  const request = client.get(currentUrl, (response) => {
                    // 处理重定向
                    if (response.statusCode >= 300 && response.statusCode < 400 && response.headers.location) {
                      const redirectUrl = new URL(response.headers.location, parsedUrl).href;
                      download(redirectUrl); // 递归处理重定向
                      return;
                    }
                    
                    if (response.statusCode !== 200) {
                      reject(new Error(`Failed to download: ${response.statusCode}`));
                      return;
                    }
                    
                    const fileStream = fs.createWriteStream(filePath);
                    response.pipe(fileStream);
                    
                    fileStream.on('finish', () => {
                      fileStream.close(resolve);
                    });
                  });
                  
                  request.on('error', (error) => {
                    reject(error);
                  });
                };
                
                download(url); // 开始下载
              });
            }

            // 获取原仓库所有Releases
            const { data: sourceReleases } = await github.rest.repos.listReleases({
              owner: 'huiyadanli',
              repo: 'RevokeMsgPatcher',
              per_page: 100
            });

            // 获取目标仓库已有的Releases
            const { data: targetReleases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // 过滤需要同步的Releases
            const existingTags = targetReleases.map(r => r.tag_name);
            const releasesToSync = sourceReleases.filter(r => !existingTags.includes(r.tag_name));

            // 批量同步Releases和Assets
            for (const release of releasesToSync) {
              console.log(`同步版本: ${release.tag_name}`);
              
              // 创建Release
              const { data: targetRelease } = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: release.tag_name,
                name: release.name,
                body: release.body,
                draft: release.draft,
                prerelease: release.prerelease
              });

              // 下载并上传Assets
              for (const asset of release.assets) {
                console.log(`同步Asset: ${asset.name}`);
                try {
                  // 检查目标Release是否已存在该Asset
                  const existingAssets = await github.rest.repos.listReleaseAssets({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: targetRelease.id
                  });
                  
                  const assetNames = existingAssets.data.map(a => a.name);
                  if (!assetNames.includes(asset.name)) {
                    // 下载Asset到临时目录
                    const assetPath = path.join('/tmp', asset.name);
                    await downloadFile(asset.browser_download_url, assetPath);
                    
                    // 上传Asset到目标Release
                    await github.rest.repos.uploadReleaseAsset({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      release_id: targetRelease.id,
                      name: asset.name,
                      data: fs.readFileSync(assetPath)
                    });
                    
                    // 清理临时文件
                    fs.unlinkSync(assetPath);
                  }
                } catch (error) {
                  console.error(`同步Asset失败: ${asset.name}`, error);
                }
              }
            }
